<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.summit.dao.repository.AlarmDao">
  <resultMap id="BaseResultMap" type="com.summit.dao.entity.Alarm">
    <result column="alarm_id" jdbcType="VARCHAR" property="alarmId" />
    <result column="alarm_name" jdbcType="VARCHAR" property="alarmName" />
    <result column="acc_ctrl_pro_id" jdbcType="VARCHAR" property="accCtrlProId" />
    <result column="alarm_time" jdbcType="TIMESTAMP" property="alarmTime" />
    <result column="alarm_status" jdbcType="INTEGER" property="alarmStatus" />
    <result column="access_control_id" jdbcType="VARCHAR" property="accessControlId" />
    <result column="access_control_name" jdbcType="VARCHAR" property="accessControlName" />
    <result column="process_person" jdbcType="VARCHAR" property="processPerson" />
    <result column="description" jdbcType="VARCHAR" property="description" />
    <result column="updatetime" jdbcType="VARCHAR" property="updatetime" />
    <result column="process_remark" jdbcType="VARCHAR" property="processRemark" />

    <association property="accCtrlProcess" javaType="com.summit.dao.entity.AccCtrlProcess">
        <result column="acc_ctrl_pro_id" jdbcType="VARCHAR" property="accCtrlProId" />
        <result column="access_control_id" jdbcType="VARCHAR" property="accessControlId" />
        <result column="access_control_name" jdbcType="VARCHAR" property="accessControlName" />
        <result column="device_id" jdbcType="VARCHAR" property="deviceId" />
        <result column="device_ip" jdbcType="VARCHAR" property="deviceIp" />
        <result column="lock_id" jdbcType="VARCHAR" property="lockId" />
        <result column="lock_code" jdbcType="VARCHAR" property="lockCode" />
        <result column="user_id" jdbcType="VARCHAR" property="userId" />
        <result column="user_name" jdbcType="VARCHAR" property="userName" />
        <result column="gender" jdbcType="INTEGER" property="gender" />
        <result column="birthday" jdbcType="TIMESTAMP" property="birthday" />
        <result column="province" jdbcType="VARCHAR" property="province" />
        <result column="city" jdbcType="VARCHAR" property="city" />
        <result column="card_type" jdbcType="INTEGER" property="cardType" />
        <result column="card_id" jdbcType="VARCHAR" property="cardId" />
        <result column="face_match_rate" jdbcType="REAL" property="faceMatchRate" />
        <result column="face_lib_name" jdbcType="VARCHAR" property="faceLibName" />
        <result column="face_lib_type" jdbcType="INTEGER" property="faceLibType" />

        <result column="process_type" jdbcType="INTEGER" property="processType" />
        <result column="process_result" jdbcType="VARCHAR" property="processResult" />
        <result column="fail_reason" jdbcType="VARCHAR" property="failReason" />
        <result column="panorama_pic_id" jdbcType="VARCHAR" property="panoramaPicId" />
        <result column="face_panorama_id" jdbcType="VARCHAR" property="facePanoramaId" />
        <result column="face_pic_id" jdbcType="VARCHAR" property="facePicId" />
        <result column="face_match_id" jdbcType="VARCHAR" property="faceMatchId" />
        <result column="process_time" jdbcType="TIMESTAMP" property="processTime" />

        <association property="accessControlInfo" javaType="com.summit.dao.entity.AccessControlInfo">
            <result column="ac_access_control_id" jdbcType="VARCHAR" property="accessControlId" />
            <result column="ac_access_control_name" jdbcType="VARCHAR" property="accessControlName" />
            <result column="ac_lock_id" jdbcType="VARCHAR" property="lockId" />
            <result column="ac_lock_code" jdbcType="VARCHAR" property="lockCode" />
            <result column="ac_entry_camera_id" jdbcType="VARCHAR" property="entryCameraId" />
            <result column="ac_entry_camera_ip" jdbcType="VARCHAR" property="entryCameraIp" />
            <result column="ac_exit_camera_id" jdbcType="VARCHAR" property="exitCameraId" />
            <result column="ac_exit_camera_ip" jdbcType="VARCHAR" property="exitCameraIp" />
            <result column="ac_status" jdbcType="INTEGER" property="status" />
            <result column="ac_createby" jdbcType="VARCHAR" property="createby" />
            <result column="ac_createtime" jdbcType="TIMESTAMP" property="createtime" />
            <result column="ac_updatetime" jdbcType="TIMESTAMP" property="updatetime" />

            <collection property="roles" resultMap="rolesResult"  />
        </association>

      <association property="facePanorama" javaType="com.summit.dao.entity.FileInfo">
        <result column="fi1_id" jdbcType="VARCHAR" property="fileId" />
        <result column="fi1_name" jdbcType="VARCHAR" property="filenName" />
        <result column="fi1_path" jdbcType="LONGVARCHAR" property="filePath" />
        <result column="fi1_des" jdbcType="LONGVARCHAR" property="description" />
      </association>
      <association property="facePic" javaType="com.summit.dao.entity.FileInfo">
        <result column="fi2_id" jdbcType="VARCHAR" property="fileId" />
        <result column="fi2_name" jdbcType="VARCHAR" property="filenName" />
        <result column="fi2_path" jdbcType="LONGVARCHAR" property="filePath" />
        <result column="fi2_des" jdbcType="LONGVARCHAR" property="description" />
      </association>
      <association property="faceMatch" javaType="com.summit.dao.entity.FileInfo">
        <result column="fi3_id" jdbcType="VARCHAR" property="fileId" />
        <result column="fi3_name" jdbcType="VARCHAR" property="filenName" />
        <result column="fi3_path" jdbcType="LONGVARCHAR" property="filePath" />
        <result column="fi3_des" jdbcType="LONGVARCHAR" property="description" />
      </association>
    </association>

  </resultMap>
    <resultMap id="rolesResult" type="com.summit.dao.entity.AccCtrlRole">
        <result column="au_id" jdbcType="VARCHAR" property="id" />
        <result column="au_role_id" jdbcType="VARCHAR" property="roleCode" />
        <result column="au_access_control_id" jdbcType="VARCHAR" property="accessControlId" />
    </resultMap>


  <sql id="Base_Column_List">
    alarm_id, alarm_name, acc_ctrl_pro_id, alarm_time, alarm_status, process_person, description,
    updatetime, process_remark
  </sql>
  <sql id="Alarm_Have_Alias_List">
    al.alarm_id, al.alarm_name, al.acc_ctrl_pro_id, al.alarm_time, al.alarm_status, al.process_person,
    al.description,al.updatetime, al.process_remark
  </sql>
    <sql id="AccCtrl_Have_Alias_List">
        acp.acc_ctrl_pro_id, acp.access_control_id, acp.access_control_name, acp.device_id, acp.device_ip,
        acp.device_type, acp.lock_id, acp.lock_code,
        acp.user_id, acp.user_name, acp.gender, acp.birthday, acp.province, acp.city, acp.card_type, acp.card_id,
        acp.face_match_rate, acp.face_lib_name, acp.face_lib_type, acp.process_type, acp.process_result,
        acp.fail_reason, acp.panorama_pic_id, acp.face_panorama_id, acp.face_pic_id, acp.face_match_id,
        acp.process_time
    </sql>
    <sql id="AccCtrlInfo_Have_Alias_List">
        ac.access_control_id ac_access_control_id, ac.access_control_name ac_access_control_name,
        ac.lock_id ac_lock_id, ac.lock_code ac_lock_code,
        ac.entry_camera_id ac_entry_camera_id, ac.entry_camera_ip ac_entry_camera_ip, ac.exit_camera_id ac_exit_camera_id,
        ac.exit_camera_ip ac_exit_camera_ip, ac.status ac_status, ac.createby ac_createby,
        ac.createtime ac_createtime, ac.updatetime ac_updatetime
    </sql>
    <sql id="Auth_Have_Alias_List">
        au.id au_id, au.role_id au_role_id, au.access_control_id au_access_control_id
    </sql>
    <sql id="Auth_No_Alias_List">
        au.id , au.role_id , au.access_control_id
    </sql>
    <sql id="Face_Panorama_Alias_List">
        fi1.file_id fi1_id, fi1.file_name fi1_name, fi1.file_path fi1_path, fi1.description fi1_des
    </sql>
    <sql id="Face_Pic_Alias_List">
        fi2.file_id fi2_id, fi2.file_name fi2_name, fi2.file_path fi2_path, fi2.description fi2_des
    </sql>
    <sql id="Face_Match_Alias_List">
        fi3.file_id fi3_id, fi3.file_name fi3_name, fi3.file_path fi3_path, fi3.description fi3_des
    </sql>

  <select id="selectAlarmById" parameterType="java.lang.String" resultMap="BaseResultMap">
    select
    <include refid="Alarm_Have_Alias_List" />,
    <include refid="AccCtrl_Have_Alias_List" />,
    <include refid="AccCtrlInfo_Have_Alias_List" />,
    <include refid="Auth_Have_Alias_List" />,
    <include refid="Face_Panorama_Alias_List" />,
    <include refid="Face_Pic_Alias_List" />,
    <include refid="Face_Match_Alias_List" />
    from (select distinct <include refid="Alarm_Have_Alias_List" /> from
    alarm al left join acc_ctrl_process acp on al.acc_ctrl_pro_id=acp.acc_ctrl_pro_id
      <if test="roles != null">
          inner join (
          select distinct <include refid="Auth_No_Alias_List" /> from role_accesscontrol_auth au
          <where>
              au.role_id in
              <foreach  item="role" collection="roles" index="index"  open="(" separator="," close=")">
                  #{role}
              </foreach>
          </where>
          ) au on au.access_control_id = acp.access_control_id
      </if>
    ) al
    left join acc_ctrl_process acp on acp.acc_ctrl_pro_id=al.acc_ctrl_pro_id
    left join file_info fi1 on acp.face_panorama_id=fi1.file_id
    left join file_info fi2 on acp.face_pic_id=fi2.file_id
    left join file_info fi3 on acp.face_match_id=fi3.file_id
    left join access_control ac on ac.access_control_id = acp.access_control_id
    left join role_accesscontrol_auth au on au.access_control_id = acp.access_control_id
    <where>
      al.alarm_id=#{alarmId}
    </where>
  </select>

  <select id="selectByAccCtrlProId" parameterType="java.lang.String" resultMap="BaseResultMap">
    select
    <include refid="Alarm_Have_Alias_List" />,
    <include refid="AccCtrl_Have_Alias_List" />,
    <include refid="AccCtrlInfo_Have_Alias_List" />,
    <include refid="Auth_Have_Alias_List" />,
    <include refid="Face_Panorama_Alias_List" />,
    <include refid="Face_Pic_Alias_List" />,
    <include refid="Face_Match_Alias_List" />
    from (select distinct <include refid="Alarm_Have_Alias_List" /> from
    alarm al left join acc_ctrl_process acp on al.acc_ctrl_pro_id=acp.acc_ctrl_pro_id
      <if test="roles != null">
          inner join (
          select distinct <include refid="Auth_No_Alias_List" /> from role_accesscontrol_auth au
          <where>
              au.role_id in
              <foreach  item="role" collection="roles" index="index"  open="(" separator="," close=")">
                  #{role}
              </foreach>
          </where>
          ) au on au.access_control_id = acp.access_control_id
      </if>
    ) al
    left join acc_ctrl_process acp on al.acc_ctrl_pro_id=acp.acc_ctrl_pro_id
    left join file_info fi1 on acp.face_panorama_id=fi1.file_id
    left join file_info fi2 on acp.face_pic_id=fi2.file_id
    left join file_info fi3 on acp.face_match_id=fi3.file_id
    left join access_control ac on ac.access_control_id = acp.access_control_id
    left join role_accesscontrol_auth au on au.access_control_id = acp.access_control_id
    <where>
      al.acc_ctrl_pro_id=#{accCtrlProId}
    </where>
  </select>

  <select id="selectAlarmCountByStatus"  resultType="java.lang.Integer">
    select  count(distinct alarm_id)
    from (
        select al.alarm_id, al.alarm_status from alarm al
        left join acc_ctrl_process acp on al.acc_ctrl_pro_id=acp.acc_ctrl_pro_id
      <if test="roles != null">
          inner join (
          select distinct <include refid="Auth_No_Alias_List" /> from role_accesscontrol_auth au
          <where>
              au.role_id in
              <foreach  item="role" collection="roles" index="index"  open="(" separator="," close=")">
                  #{role}
              </foreach>
          </where>
          ) au on au.access_control_id = acp.access_control_id
      </if>
    ) al

    <where>
        al.alarm_status=#{alarmStatus}
    </where>
  </select>


  <select id="selectCondition" resultMap="BaseResultMap">
    select
    <include refid="Alarm_Have_Alias_List" />,
    <include refid="AccCtrl_Have_Alias_List" />,
    <include refid="AccCtrlInfo_Have_Alias_List" />,
    <include refid="Auth_Have_Alias_List" />,
    <include refid="Face_Panorama_Alias_List" />,
    <include refid="Face_Pic_Alias_List" />,
    <include refid="Face_Match_Alias_List" />
    from (select distinct <include refid="Alarm_Have_Alias_List" /> from
        alarm al left join acc_ctrl_process acp on al.acc_ctrl_pro_id=acp.acc_ctrl_pro_id
      <if test="roles != null">
          inner join (
          select distinct <include refid="Auth_No_Alias_List" /> from role_accesscontrol_auth au
          <where>
              au.role_id in
              <foreach  item="role" collection="roles" index="index"  open="(" separator="," close=")">
                  #{role}
              </foreach>
          </where>
          ) au on au.access_control_id = acp.access_control_id
      </if>

      <where>
          <if test="alarm.alarmId != null">
              al.alarm_id = #{alarm.alarmId}
          </if>
          <if test="alarm.alarmName != null">
              and al.alarm_name = #{alarm.alarmName}
          </if>
          <if test="alarm.accCtrlProId != null">
              and al.acc_ctrl_pro_id = #{alarm.accCtrlProId}
          </if>
          <!--      <if test="alarm.accCtrlProcess != null and alarm.accCtrlProcess.accessControlName != null">-->
          <!--        and ac.access_control_name = #{alarm.accCtrlProcess.accessControlName}-->
          <!--      </if>-->
          <if test="alarm.accessControlId != null ">
              and acp.access_control_id = #{alarm.accessControlId}
          </if>
          <if test="alarm.accessControlName != null ">
              and acp.access_control_name = #{alarm.accessControlName}
          </if>
          <if test="alarm.alarmStatus != null">
              and al.alarm_status = #{alarm.alarmStatus}
          </if>
          <if test="alarm.processPerson != null">
              and al.process_person = #{alarm.processPerson}
          </if>
          <if test="alarm.description != null">
              and al.description = #{alarm.description}
          </if>
          <if test="alarm.processRemark != null">
              and al.process_remark = #{alarm.processRemark}
              <!--        and al.process_remark like concat(concat('%', #{alarm.processRemark}), '%');-->
          </if>
          <if test="start != null">
              and al.alarm_time &gt;= #{start}
          </if>
          <if test="end != null">
              and al.alarm_time &lt;= #{end}
          </if>
      </where>
      order by alarm_time desc

      <if test="page != null and page.current != null and  page.pageSize != null ">
        limit #{page.current},#{page.pageSize}
      </if>
    ) al
    left join acc_ctrl_process acp on al.acc_ctrl_pro_id=acp.acc_ctrl_pro_id
    left join file_info fi1 on acp.face_panorama_id=fi1.file_id
    left join file_info fi2 on acp.face_pic_id=fi2.file_id
    left join file_info fi3 on acp.face_match_id=fi3.file_id
    left join access_control ac on ac.access_control_id = acp.access_control_id
    left join role_accesscontrol_auth au on au.access_control_id = acp.access_control_id

  </select>


</mapper>